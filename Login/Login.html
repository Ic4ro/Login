<!DOCTYPE html>
<html>
<head>
    <base href="/" />
    <meta charset="UTF-8">
    <title>Sistema de Gestão Completo</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
      /* --- Estilos Globais --- */
      * { margin: 0; padding: 0; box-sizing: border-box; }

      html, body {
        height: 100%;
      }

      body, body.app-mode {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: background 0.5s ease;
      }

      /* --- Estilos das Telas de Login --- */
      .login-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        min-height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
        transition: opacity 0.5s ease;
      }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
      .container { background: #ffffff; padding: 40px 50px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%; max-width: 420px; text-align: center; animation: fadeIn 0.6s ease-out; }
      h1 { font-size: 28px; font-weight: 600; color: #333; margin-bottom: 8px; text-align: left; }
      .subtitle { font-size: 15px; color: #888; margin-bottom: 30px; text-align: left; }
      .input-wrapper { position: relative; margin-bottom: 20px; }
      .input-wrapper .icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 16px; }
      input { width: 100%; padding: 14px 20px 14px 50px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; font-family: 'Poppins', sans-serif; transition: all 0.3s ease; background-color: #f9f9f9; }
      input:focus { outline: none; border-color: #667eea; background-color: #fff; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
      .input-wrapper .eye-icon { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; }
      button { width: 100%; padding: 15px; border: none; border-radius: 10px; background: linear-gradient(90deg, #667eea, #764ba2); color: white; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; margin-top: 15px; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; }
      button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
      .links { margin-top: 25px; font-size: 14px; }
      .links a { color: #667eea; text-decoration: none; margin: 0 8px; font-weight: 500; }
      .links a:hover { text-decoration: underline; }
      .password-requirements { text-align: left; font-size: 13px; color: #888; margin: -10px 0 20px 10px; }
      .password-requirements ul { list-style: none; padding-left: 0; }
      .password-requirements li { margin: 5px 0; transition: all 0.3s ease; }
      .password-requirements li::before { display: inline-block; width: 20px; text-align: center; margin-left: -20px; }
      .password-requirements li.invalid::before { content: '✗'; color: #dc3545; }
      .password-requirements li.valid::before { content: '✓'; color: #28a745; }
      .password-requirements li.valid { color: #28a745; font-weight: 500; }
      .password-requirements li.invalid { color: #dc3545; }
      .error-message { color: #dc3545; font-size: 12px; text-align: left; margin: -15px 0 15px 5px; display: none; }

      /* --- ESTILOS DA NOVA TELA DE GESTÃO DE PRODUTOS --- */
      #productManagementPage { width: 100%; min-height: 100vh; display: none; padding: 20px; }
      .app-container { max-width: 1200px; margin: 20px auto; background: #fff; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); overflow: hidden; }
      .app-header { background-color: #ffffff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
      .app-header h1 { font-size: 24px; margin: 0; color: #667eea; }
      #logoutBtn { background: #f44336; color: white; padding: 8px 15px; border-radius: 8px; font-weight: 500; font-size: 14px; width: auto; margin: 0; box-shadow: none; }
      #logoutBtn:hover { background: #d32f2f; transform: none; }
      .app-main { padding: 30px; }
      .toolbar { display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-between; align-items: center; margin-bottom: 30px; }
      #addProductBtn { width: auto; padding: 12px 20px; font-size: 15px; margin: 0; }
      .search-wrapper { position: relative; width: 100%; max-width: 350px; }
      .search-wrapper .icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
      #searchInput { width: 100%; padding: 12px 20px 12px 45px; font-size: 15px; margin: 0; background-color: #f0f2f5; }
      .table-wrapper { width: 100%; overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 15px; text-align: left; white-space: nowrap; }
      thead { background-color: #f9fafb; }
      th { font-weight: 600; color: #555; font-size: 14px; text-transform: uppercase; }
      tbody tr { border-bottom: 1px solid #f0f0f0; }
      tbody tr:last-child { border-bottom: none; }
      tbody tr:hover { background-color: #f5f3ff; }
      .actions-cell button { background: none; box-shadow: none; padding: 5px 8px; margin: 0 4px; font-size: 16px; width: auto; border-radius: 5px; }
      .edit-btn { color: #667eea; }
      .delete-btn { color: #f44336; }
      .edit-btn:hover { background-color: rgba(102, 126, 234, 0.1); }
      .delete-btn:hover { background-color: rgba(244, 67, 54, 0.1); }

      /* Estilos do Modal */
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
      .modal-content { background-color: #fff; border-radius: 15px; width: 100%; max-width: 500px; animation: fadeIn 0.3s; }
      .modal-header { padding: 20px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
      .modal-header h2 { text-align: left; }
      .close-btn { font-size: 24px; color: #aaa; cursor: pointer; background: none; border: none; padding: 0; width: auto; margin: 0; box-shadow: none; }
      .modal-body { padding: 30px; }
      .modal-body .input-wrapper input { background-color: #fff; }
      .modal-footer { padding: 20px 30px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; }
      .modal-footer button { width: auto; margin: 0 0 0 10px; padding: 10px 25px; font-size: 15px; }
      #cancelBtn { background: #f0f0f0; color: #555; box-shadow: none; }
    </style>
</head>
<body>

<div class="login-wrapper">
    <div class="container" id="loginPage">
      <h1>Bem-vindo</h1>
      <p class="subtitle">Faça login para continuar</p>
      <form id="loginForm" novalidate>
        <div class="input-wrapper"><i class="icon fa-regular fa-envelope"></i><input type="email" id="loginEmail" placeholder="Email" required autocomplete="off"></div>
        <div class="input-wrapper"><i class="icon fa-solid fa-lock"></i><input type="password" id="loginPassword" placeholder="Senha" required autocomplete="new-password"><i class="eye-icon fa-solid fa-eye-slash" id="toggleLoginPassword"></i></div>
        <button type="submit">Entrar</button>
      </form>
      <div class="links"><a href="javascript:void(0)" onclick="showPage('forgotPasswordPage')">Esqueceu sua senha?</a><span>|</span><a href="javascript:void(0)" onclick="showPage('registerPage')">Cadastre-se</a></div>
    </div>
    
    <div class="container" id="forgotPasswordPage" style="display: none;">
      <h1>Recuperar Senha</h1>
      <p class="subtitle">Insira seu e-mail de recuperação.</p>
      <form id="forgotPasswordForm" novalidate><div class="input-wrapper"><i class="icon fa-regular fa-envelope"></i><input type="email" id="recoveryEmail" placeholder="Digite seu email" required></div><div class="error-message" id="recoveryEmailError">Email inválido</div><button type="submit">Enviar</button></form>
      <div class="links"><a href="javascript:void(0)" onclick="showPage('loginPage')">Voltar ao login</a></div>
    </div>

    <div class="container" id="registerPage" style="display: none;">
      <h1>Crie sua Conta</h1>
      <p class="subtitle">É rápido e fácil.</p>
      <form id="registerForm" novalidate>
        <div class="input-wrapper"><i class="icon fa-regular fa-user"></i><input type="text" id="fullName" placeholder="Nome completo" required autocomplete="off"></div>
        <div class="error-message" id="nameError">O nome deve ter ao menos 3 caracteres</div>
        <div class="input-wrapper"><i class="icon fa-regular fa-envelope"></i><input type="email" id="email" placeholder="Email" required autocomplete="off"></div>
        <div class="error-message" id="emailError">Formato de e-mail inválido (ex: nome@dominio.com)</div>
        <div class="input-wrapper"><i class="icon fa-solid fa-lock"></i><input type="password" id="password" placeholder="Senha" required autocomplete="new-password"><i class="eye-icon fa-solid fa-eye-slash" id="toggleRegisterPassword"></i></div>
        <div class="password-requirements">
          <ul><li id="lengthCheck">Mínimo de 8 caracteres</li><li id="upperCheck">Uma letra maiúscula</li><li id="numberCheck">Um número</li><li id="specialCheck">Um caractere especial</li></ul>
        </div>
        <div class="input-wrapper"><i class="icon fa-solid fa-lock"></i><input type="password" id="confirmPassword" placeholder="Confirme a senha" required autocomplete="new-password"><i class="eye-icon fa-solid fa-eye-slash" id="toggleConfirmPassword"></i></div>
        <div class="error-message" id="passwordError">As senhas não coincidem</div>
        <button type="submit">Criar conta</button>
      </form>
      <div class="links"><a href="javascript:void(0)" onclick="showPage('loginPage')">Já tem uma conta?</a></div>
    </div>

    <div class="container" id="resetPasswordPage" style="display: none;">
      <h1>Alterar Senha</h1>
      <p class="subtitle">Crie uma nova senha para sua conta.</p>
      <form id="resetPasswordForm" novalidate>
        <div class="input-wrapper"><i class="icon fa-solid fa-lock"></i><input type="password" id="newPassword" placeholder="Nova senha" required autocomplete="new-password"><i class="eye-icon fa-solid fa-eye-slash" id="toggleNewPassword"></i></div>
        <div class="password-requirements">
          <ul><li id="newLengthCheck">Mínimo de 8 caracteres</li><li id="newUpperCheck">Uma letra maiúscula</li><li id="newNumberCheck">Um número</li><li id="newSpecialCheck">Um caractere especial</li></ul>
        </div>
        <div class="input-wrapper"><i class="icon fa-solid fa-lock"></i><input type="password" id="confirmNewPassword" placeholder="Confirme a nova senha" required autocomplete="new-password"><i class="eye-icon fa-solid fa-eye-slash" id="toggleConfirmNewPassword"></i></div>
        <div class="error-message" id="resetPasswordError">As senhas não coincidem</div>
        <button type="submit">Salvar nova senha</button>
      </form>
      <div class="links"><a href="javascript:void(0)" onclick="showPage('loginPage')">Voltar ao login</a></div>
    </div>
</div>

<div id="productManagementPage">
    <div class="app-container">
        <header class="app-header"><h1>Gestão de Produtos</h1><button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Sair</button></header>
        <main class="app-main">
            <div class="toolbar">
                <div class="search-wrapper"><i class="icon fa-solid fa-magnifying-glass"></i><input type="search" id="searchInput" placeholder="Buscar por nome ou categoria..."></div>
                <button id="addProductBtn"><i class="fa-solid fa-plus"></i> Adicionar Produto</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>ID</th><th>Produto</th><th>Categoria</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modalTitle">Adicionar Produto</h2><button class="close-btn" type="button" aria-label="Fechar">&times;</button></div>
        <form id="productForm" novalidate>
            <div class="modal-body">
                <input type="hidden" id="productId">
                <div class="input-wrapper"><i class="icon fa-solid fa-box"></i><input type="text" id="productName" placeholder="Nome do Produto" required></div>
                <div class="input-wrapper"><i class="icon fa-solid fa-tag"></i><input type="text" id="productCategory" placeholder="Categoria"></div>
                <div class="input-wrapper"><i class="icon fa-solid fa-dollar-sign"></i><input type="number" id="productPrice" placeholder="Preço" step="0.01" min="0" required></div>
                <div class="input-wrapper"><i class="icon fa-solid fa-cubes"></i><input type="number" id="productStock" placeholder="Estoque" min="0"></div>
            </div>
            <div class="modal-footer"><button type="button" id="cancelBtn">Cancelar</button><button type="submit">Salvar</button></div>
        </form>
    </div>
</div>

<script>
// --- Referências principais ---
const loginWrapper = document.querySelector('.login-wrapper');
const productManagementPage = document.getElementById('productManagementPage');
const tableBody = document.getElementById('productTableBody');
const productModal = document.getElementById('productModal');
const productForm = document.getElementById('productForm');
const modalTitle = document.getElementById('modalTitle');

// --- Utilidades / Persistência ---
const STORAGE_KEYS = {
  products: 'app_products',
  nextId: 'app_products_next_id',
  session: 'app_logged_in'
};

function saveProducts() {
  localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products));
  localStorage.setItem(STORAGE_KEYS.nextId, String(nextProductId));
}

function loadProducts() {
  const data = localStorage.getItem(STORAGE_KEYS.products);
  const next = localStorage.getItem(STORAGE_KEYS.nextId);
  if (data) {
    try {
      products = JSON.parse(data);
      nextProductId = Number(next) || (products.reduce((m,p)=>Math.max(m, p.id||0),0) + 1);
    } catch {
      // fallback se houver dados corrompidos
      products = getSeedProducts();
      nextProductId = 5;
      saveProducts();
    }
  } else {
    products = getSeedProducts();
    nextProductId = 5;
    saveProducts();
  }
}

function getSeedProducts() {
  return [
    { id: 1, name: 'Notebook Pro X', category: 'Eletrônicos', price: 7500.00, stock: 15 },
    { id: 2, name: 'Smartphone Z10', category: 'Eletrônicos', price: 3200.50, stock: 30 },
    { id: 3, name: 'Cadeira Gamer Ergo', category: 'Móveis', price: 1800.00, stock: 10 },
    { id: 4, name: 'Teclado Mecânico RGB', category: 'Acessórios', price: 450.75, stock: 50 }
  ];
}

// --- Navegação entre telas de login ---
function showPage(pageId) {
  document.querySelectorAll('.login-wrapper .container').forEach(c => c.style.display = 'none');
  const el = document.getElementById(pageId);
  if (el) el.style.display = 'block';
}

function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase()); }

// Validação de senha (registro e reset)
function validatePassword(password, type = '') {
  const checks = {
      length: password.length >= 8,
      upper: /[A-Z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(password),
  };
  updateCheck(type === 'new' ? 'newLengthCheck' : 'lengthCheck', checks.length, password);
  updateCheck(type === 'new' ? 'newUpperCheck' : 'upperCheck', checks.upper, password);
  updateCheck(type === 'new' ? 'newNumberCheck' : 'numberCheck', checks.number, password);
  updateCheck(type === 'new' ? 'newSpecialCheck' : 'specialCheck', checks.special, password);
  return Object.values(checks).every(Boolean);
}

function updateCheck(elementId, isValid, password) {
  const el = document.getElementById(elementId);
  if (!el) return;
  if (password.length === 0) {
    el.classList.remove('valid', 'invalid');
  } else {
    el.classList.toggle('valid', isValid);
    el.classList.toggle('invalid', !isValid);
  }
}

// --- Controle de visibilidade de senha ---
function setupPasswordToggle(inputId, toggleId) {
  const passwordInput = document.getElementById(inputId);
  const toggleIcon = document.getElementById(toggleId);
  if (!passwordInput || !toggleIcon) return;
  toggleIcon.addEventListener('click', function() {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.classList.toggle('fa-eye-slash');
    this.classList.toggle('fa-eye');
  });
}

function setupSyncedToggles(passId1, passId2, toggleId1, toggleId2) {
  const pass1 = document.getElementById(passId1);
  const pass2 = document.getElementById(passId2);
  const t1 = document.getElementById(toggleId1);
  const t2 = document.getElementById(toggleId2);
  if (!pass1 || !pass2 || !t1 || !t2) return;
  const toggles = [t1, t2];
  toggles.forEach(toggle => {
    toggle.addEventListener('click', () => {
      const newType = pass1.getAttribute('type') === 'password' ? 'text' : 'password';
      pass1.setAttribute('type', newType);
      pass2.setAttribute('type', newType);
      toggles.forEach(icon => {
        icon.classList.toggle('fa-eye-slash');
        icon.classList.toggle('fa-eye');
      });
    });
  });
}

// --- Estado da aplicação (produtos) ---
let products = [];
let nextProductId = 5;
let editingProductId = null;

// --- Render da tabela ---
function renderTable(productsToRender) {
  tableBody.innerHTML = '';
  const list = productsToRender && Array.isArray(productsToRender) ? productsToRender : products;
  if (list.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum produto encontrado.</td></tr>`;
    return;
  }
  list.forEach(product => {
    const row = document.createElement('tr');
    row.dataset.id = product.id;
    const priceBR = `R$ ${Number(product.price || 0).toFixed(2).replace('.', ',')}`;
    row.innerHTML = `
      <td>#${product.id}</td>
      <td>${product.name || ''}</td>
      <td>${product.category || ''}</td>
      <td>${priceBR}</td>
      <td>${Number.isFinite(product.stock) ? product.stock : 0}</td>
      <td class="actions-cell">
        <button class="edit-btn" title="Editar"><i class="fa-solid fa-pencil"></i></button>
        <button class="delete-btn" title="Excluir"><i class="fa-solid fa-trash"></i></button>
      </td>`;
    tableBody.appendChild(row);
  });
}

// --- Modal ---
function openModal(productId = null) {
  productForm.reset();
  editingProductId = productId ? Number(productId) : null;
  if (editingProductId) {
    modalTitle.textContent = 'Editar Produto';
    const product = products.find(p => p.id === editingProductId);
    if (product) {
      document.getElementById('productId').value = product.id;
      document.getElementById('productName').value = product.name || '';
      document.getElementById('productCategory').value = product.category || '';
      document.getElementById('productPrice').value = product.price ?? 0;
      document.getElementById('productStock').value = product.stock ?? 0;
    }
  } else {
    modalTitle.textContent = 'Adicionar Produto';
  }
  productModal.style.display = 'flex';
}

function closeModal() { productModal.style.display = 'none'; }

// --- CRUD ---
function handleFormSubmit(e) {
  e.preventDefault();
  const name = document.getElementById('productName').value.trim();
  const category = document.getElementById('productCategory').value.trim();
  const priceVal = document.getElementById('productPrice').value;
  const stockVal = document.getElementById('productStock').value;

  if (!name || priceVal.trim() === '') {
    Swal.fire({icon: 'error', title: 'Campos obrigatórios', text: 'Nome e Preço do produto são obrigatórios.'});
    return;
  }

  const productData = {
    id: editingProductId ?? undefined,
    name,
    category,
    price: parseFloat(priceVal) || 0,
    stock: parseInt(stockVal) || 0
  };

  if (editingProductId) {
    products = products.map(p => p.id === editingProductId ? { ...p, ...productData, id: editingProductId } : p);
  } else {
    productData.id = nextProductId++;
    products.push(productData);
  }

  saveProducts();
  renderTable();
  closeModal();
  Swal.fire({ icon: 'success', title: 'Sucesso!', text: 'Produto salvo com sucesso.', timer: 1500, showConfirmButton: false });
}

function handleDelete(productId) {
  Swal.fire({
    title: 'Você tem certeza?',
    text: "Esta ação não pode ser desfeita!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Sim, deletar!',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      products = products.filter(p => p.id !== Number(productId));
      saveProducts();
      renderTable();
      Swal.fire('Deletado!', 'O produto foi removido.', 'success');
    }
  });
}

// --- Listeners de UI Produtos ---
document.getElementById('searchInput').addEventListener('input', (e) => {
  const term = e.target.value.toLowerCase();
  const filtered = products.filter(p =>
    (p.name || '').toLowerCase().includes(term) ||
    (p.category || '').toLowerCase().includes(term)
  );
  renderTable(filtered);
});

tableBody.addEventListener('click', function(e) {
  const editBtn = e.target.closest('.edit-btn');
  const deleteBtn = e.target.closest('.delete-btn');
  if (editBtn) openModal(editBtn.closest('tr').dataset.id);
  if (deleteBtn) handleDelete(deleteBtn.closest('tr').dataset.id);
});

document.getElementById('addProductBtn').addEventListener('click', () => openModal());
document.getElementById('cancelBtn').addEventListener('click', closeModal);
document.querySelector('.close-btn').addEventListener('click', closeModal);
productForm.addEventListener('submit', handleFormSubmit);
window.addEventListener('click', (e) => { if (e.target === productModal) closeModal(); });

// --- Login / Sessão ---
setupPasswordToggle('loginPassword', 'toggleLoginPassword');
setupSyncedToggles('password', 'confirmPassword', 'toggleRegisterPassword', 'toggleConfirmPassword');
setupSyncedToggles('newPassword', 'confirmNewPassword', 'toggleNewPassword', 'toggleConfirmNewPassword');

document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;
  if (email.trim() === '' || pass.trim() === '') {
    Swal.fire({ icon: 'warning', title: 'Atenção!', text: 'Por favor, preencha todos os campos.' });
    return;
  }
  // Mock login
  if (email === 'admin@admin.com' && pass === '1234') {
    localStorage.setItem(STORAGE_KEYS.session, 'true');
    Swal.fire({ title: 'Sucesso!', text: 'Login bem-sucedido!', icon: 'success', timer: 1200, showConfirmButton: false })
    .then(() => {
        loginWrapper.style.display = 'none';
        productManagementPage.style.display = 'block';
        document.body.classList.add('app-mode');
        renderTable(products);
    });
  } else {
    Swal.fire({ title: 'Erro!', text: 'Email ou senha inválidos.', icon: 'error', confirmButtonText: 'Tentar Novamente' });
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem(STORAGE_KEYS.session);
  loginWrapper.style.display = 'flex';
  productManagementPage.style.display = 'none';
  document.body.classList.remove('app-mode');
  document.getElementById('loginForm').reset();
  showPage('loginPage');
});

// --- Recuperação / Registro / Reset ---
document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('recoveryEmail').value;
  const errorElement = document.getElementById('recoveryEmailError');
  if (!validateEmail(email)) { errorElement.style.display = 'block'; return; }
  errorElement.style.display = 'none';
  Swal.fire({ title: 'Enviado!', text: 'Se o e-mail estiver cadastrado, você receberá as instruções.', icon: 'success', timer: 1500, showConfirmButton: false })
   .then(() => { showPage('resetPasswordPage'); });
});

document.getElementById('registerForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const fullNameInput = document.getElementById('fullName');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');

  const nameError = document.getElementById('nameError');
  const emailError = document.getElementById('emailError');
  const passwordError = document.getElementById('passwordError');

  const isNameValid = fullNameInput.value.trim().length >= 3;
  const isEmailValid = validateEmail(emailInput.value);
  const isPasswordStrong = validatePassword(passwordInput.value, '');
  const doPasswordsMatch = passwordInput.value === confirmPasswordInput.value;

  nameError.style.display = (!isNameValid ? 'block' : 'none');
  emailError.style.display = (!isEmailValid ? 'block' : 'none');
  passwordError.style.display = (!doPasswordsMatch ? 'block' : 'none');

  if (isNameValid && isEmailValid && isPasswordStrong && doPasswordsMatch) {
    Swal.fire('Sucesso!', 'Conta criada com sucesso!', 'success').then(() => {
      showPage('loginPage');
      e.target.reset();
      validatePassword('', '');
    });
  } else {
    Swal.fire({ icon: 'error', title: 'Oops...', text: 'Por favor, corrija os campos com erro antes de continuar.' });
  }
});

document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const newPassword = document.getElementById('newPassword').value;
  const confirmNewPassword = document.getElementById('confirmNewPassword').value;
  const isPasswordStrong = validatePassword(newPassword, 'new');
  const doPasswordsMatch = newPassword === confirmNewPassword;

  const resetPasswordError = document.getElementById('resetPasswordError');

  if (newPassword.trim() === '' || confirmNewPassword.trim() === '') {
    Swal.fire({ icon: 'warning', text: 'Por favor, preencha todos os campos.'});
    return;
  }
  resetPasswordError.style.display = (!doPasswordsMatch ? 'block' : 'none');

  if(isPasswordStrong && doPasswordsMatch) {
    Swal.fire('Sucesso!', 'Sua senha foi alterada!', 'success').then(() => {
      showPage('loginPage');
      e.target.reset();
      validatePassword('', 'new');
    });
  } else {
    Swal.fire({ icon: 'error', title: 'Oops...', text: 'Por favor, corrija os campos com erro antes de continuar.' });
  }
});

// --- Validações reativas (com guardas) ---
const registerPasswordInput = document.getElementById('password');
if (registerPasswordInput) {
  registerPasswordInput.addEventListener('input', function() { validatePassword(this.value, ''); });
}
const resetPasswordInput = document.getElementById('newPassword');
if (resetPasswordInput) {
  resetPasswordInput.addEventListener('input', function() { validatePassword(this.value, 'new'); });
}
const fullNameInputLive = document.getElementById('fullName');
const nameErrorLive = document.getElementById('nameError');
if (fullNameInputLive && nameErrorLive) {
  fullNameInputLive.addEventListener('input', () => {
    nameErrorLive.style.display = fullNameInputLive.value.length > 0 && fullNameInputLive.value.length < 3 ? 'block' : 'none';
  });
}
const emailInputLive = document.getElementById('email');
const emailErrorLive = document.getElementById('emailError');
if (emailInputLive && emailErrorLive) {
  emailInputLive.addEventListener('input', () => {
    emailErrorLive.style.display = emailInputLive.value.length > 0 && !validateEmail(emailInputLive.value) ? 'block' : 'none';
  });
}
const confirmPasswordInputLive = document.getElementById('confirmPassword');
const passwordErrorLive = document.getElementById('passwordError');
if (registerPasswordInput && confirmPasswordInputLive && passwordErrorLive) {
  [registerPasswordInput, confirmPasswordInputLive].forEach(input => {
    input.addEventListener('input', () => {
      passwordErrorLive.style.display = confirmPasswordInputLive.value.length > 0 && registerPasswordInput.value !== confirmPasswordInputLive.value ? 'block' : 'none';
    });
  });
}
const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
const resetPasswordErrorLive = document.getElementById('resetPasswordError');
if (resetPasswordInput && confirmNewPasswordInput && resetPasswordErrorLive) {
  [resetPasswordInput, confirmNewPasswordInput].forEach(input => {
    input.addEventListener('input', () => {
      resetPasswordErrorLive.style.display =
        confirmNewPasswordInput.value.length > 0 && resetPasswordInput.value !== confirmNewPasswordInput.value ? 'block' : 'none';
    });
  });
}

// --- Boot ---
(function init() {
  // carrega produtos do storage
  loadProducts();

  // restaura sessão
  const logged = localStorage.getItem(STORAGE_KEYS.session) === 'true';
  if (logged) {
    loginWrapper.style.display = 'none';
    productManagementPage.style.display = 'block';
    document.body.classList.add('app-mode');
    renderTable(products);
  } else {
    loginWrapper.style.display = 'flex';
    productManagementPage.style.display = 'none';
    document.body.classList.remove('app-mode');
    showPage('loginPage');
  }
})();
</script>
</body>
</html>
